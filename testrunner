#!/bin/bash

set -e

REPORT_DIRECTORY='reports/'

usage() {
  print "Usage: %s <type CE/PRO>\n\n" "$0" >&2
  print "Usage example: %s CE\n" "$0" >&2
}

if [ $# -lt 1 ] ; then
  usage
  exit 1
fi

case "$1" in
  ce|CE) TYPE="ce" ;;
  pro|PRO) TYPE="pro" ;;
  *) echo "ERRRO: Unknown type '$1'" >&2 ; usage ; exit 1 ;;
esac

echo "Rebuilding test configs in /etc/ngcp-test/"
ngcpcfg build /etc/ngcp-test/*

rm -rf "${REPORT_DIRECTORY}"
mkdir -p "${REPORT_DIRECTORY}"
TAP_RESULTS="${REPORT_DIRECTORY}/goss_${TYPE}_results.tap"

# TODO: add --format=tap when TAP formater will be supported
if goss -g "/etc/ngcp-tests/goss_${TYPE}.json" validate ; then
  echo "1..1" > "${TAP_RESULTS}" 2>&1
  echo "ok 1 - no error were found" >> "${TAP_RESULTS}" 2>&1
else
  echo "1..1" > "${TAP_RESULTS}" 2>&1
  echo "not ok 1 - found errors, run test manually" >> "${TAP_RESULTS}" 2>&1
fi

